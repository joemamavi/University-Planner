<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CampusOS</title>
    
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#10b981">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2666/2666505.png">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root {
            /* MINT LEAF PALETTE */
            --bg-body: #f0fdf4; --bg-sidebar: #ffffff; --card-bg: #ffffff; --border-color: #d1fae5;
            --primary-color: #10b981; --primary-hover: #059669; --primary-light: #d1fae5;
            --text-main: #111827; --text-muted: #6b7280;
            --sidebar-width: 260px;
            --shadow-sm: 0 1px 2px 0 rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
        }

        body { background-color: var(--bg-body); font-family: system-ui, -apple-system, sans-serif; color: var(--text-main); }
        h1, h2, h3, h4, h5, h6 { color: #0f172a; font-weight: 600; }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-width); height: 100vh; position: fixed; top: 0; left: 0; background: var(--bg-sidebar); border-right: 1px solid var(--border-color); padding: 25px; display: flex; flex-direction: column; z-index: 1000; box-shadow: var(--shadow-sm); }
        .brand { font-size: 1.4rem; font-weight: 700; color: var(--primary-color); margin-bottom: 2.5rem; display: flex; align-items: center; gap: 12px; }
        .nav-link { display: flex; align-items: center; gap: 14px; padding: 12px 18px; color: var(--text-muted); border-radius: 12px; transition: 0.2s; margin-bottom: 8px; font-weight: 500; }
        .nav-link:hover, .nav-link.active { background-color: var(--primary-light); color: var(--primary-hover); font-weight: 600; }
        .nav-link i { font-size: 1.2rem; }

        /* CONTENT */
        .main-content { margin-left: var(--sidebar-width); padding: 40px 40px 100px 40px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 40px; }
        .search-box { background: white; border: 1px solid var(--border-color); padding: 10px 20px; border-radius: 100px; display: flex; align-items: center; width: 380px; gap: 12px; color: var(--text-muted); box-shadow: var(--shadow-sm); }
        .search-box input { border: none; outline: none; width: 100%; color: var(--text-main); }

        /* CARDS */
        .dashboard-card { background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 20px; padding: 25px; height: 100%; box-shadow: var(--shadow-md); transition: transform 0.2s ease; }
        .dashboard-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .widget-icon { width: 45px; height: 45px; border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; background: var(--primary-light); color: var(--primary-color); }
        
        /* COACH & ALERTS */
        .gap-alert { background: #ecfdf5; border: 1px solid #a7f3d0; color: #047857; border-radius: 12px; padding: 15px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow-sm); }
        .exam-banner { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 20px; padding: 30px; margin-bottom: 30px; display: flex; align-items: center; justify-content: space-between; box-shadow: var(--shadow-md); }
        .exam-banner h1, .exam-banner div { color: white !important; }
        .coach-card { background: linear-gradient(to right, #fffbeb, #ffffff); border: 1px solid #fcd34d; border-left: 5px solid #f59e0b; border-radius: 16px; padding: 20px; margin-bottom: 25px; box-shadow: var(--shadow-md); transition: transform 0.2s; }
        .coach-card:hover { transform: translateY(-2px); }
        .coach-icon { color: #d97706; background: #fef3c7; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border-radius: 10px; font-size: 1.2rem; }

        /* COLORS */
        .color-option { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: 0.2s; display: inline-block; margin-right: 8px; }
        .color-option:hover, .color-option.active { transform: scale(1.2); border-color: #1f2937; }
        .bg-emerald { background-color: #10b981; } .bg-blue { background-color: #3b82f6; } .bg-purple { background-color: #8b5cf6; }
        .bg-amber { background-color: #f59e0b; } .bg-rose { background-color: #f43f5e; } .bg-slate { background-color: #64748b; }
        .task-strip { width: 5px; height: 100%; position: absolute; left: 0; top: 0; border-radius: 4px 0 0 4px; }
        .border-emerald { background-color: #10b981; } .border-blue { background-color: #3b82f6; } .border-purple { background-color: #8b5cf6; } .border-amber { background-color: #f59e0b; } .border-rose { background-color: #f43f5e; } .border-slate { background-color: #64748b; }

        /* UTILS */
        .btn-primary { background: var(--primary-color); border: none; padding: 10px 20px; border-radius: 12px; font-weight: 600; color: white; box-shadow: var(--shadow-sm); transition: 0.2s; }
        .btn-primary:hover { background: var(--primary-hover); transform: translateY(-1px); box-shadow: var(--shadow-md); }
        .btn-outline-secondary { border: 1px solid var(--border-color); color: var(--text-muted); background: white; }
        .btn-outline-secondary:hover { background: #f9fafb; color: var(--text-main); border-color: #d1d5db; }
        .progress-slim { height: 6px; border-radius: 10px; background: #e2e8f0; margin-top: 5px; }
        .syllabus-mini { height: 4px; border-radius: 2px; background: #e2e8f0; width: 100%; display: block; margin-top: 6px; overflow: hidden; }
        .table { --bs-table-bg: transparent; color: var(--text-main); border-color: var(--border-color); }
        .table td { border-bottom: 1px solid var(--border-color); padding: 16px 12px; }
        .modal-content { background-color: white; border: 0; border-radius: 16px; box-shadow: var(--shadow-lg); }
        .form-control, .form-select { background-color: #f9fafb; border: 1px solid #d1d5db; color: var(--text-main); }
        .form-control:focus, .form-select:focus { background-color: white; border-color: var(--primary-color); }
        .bg-light-hover:hover { background-color: #f1f5f9; cursor: pointer; border-radius: 8px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="brand"><i class="bi bi-mortarboard-fill"></i> CampusOS</div>
    <nav class="nav flex-column">
        <a href="/" class="nav-link active"><i class="bi bi-grid-fill"></i> Dashboard</a>
        <a href="/career" class="nav-link"><i class="bi bi-briefcase-fill"></i> Career Vault</a>
        <a href="/timetable" class="nav-link"><i class="bi bi-table"></i> Timetable</a>
        <a href="/calendar" class="nav-link"><i class="bi bi-calendar-event"></i> Calendar</a>
        <a href="/matrix" class="nav-link"><i class="bi bi-layers-fill"></i> Priority Matrix</a>
    </nav>
    <div class="mt-auto">
        <div class="nav-link" style="background: #f8fafc; border: 1px solid var(--border-color); cursor: default;">
            <div class="d-flex align-items-center gap-3">
                <div class="bg-white rounded-circle d-flex align-items-center justify-content-center border" style="width: 40px; height: 40px; color: var(--text-muted);"><i class="bi bi-person-fill"></i></div>
                <div style="line-height: 1.3;"><div class="fw-bold" style="font-size: 0.9rem;">{{ settings.student_name }}</div><div class="text-muted" style="font-size: 0.75rem;">{{ settings.university }}</div></div>
            </div>
        </div>
        <button class="btn btn-outline-secondary w-100 btn-sm mt-3 border-0 bg-transparent text-start ps-0" data-bs-toggle="modal" data-bs-target="#profileModal"><i class="bi bi-gear me-2"></i> Settings</button>
    </div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div><h2 class="fw-bold mb-1">Hi, {{ settings.student_name.split(' ')[0] }}! üëã</h2><p class="text-muted mb-0 small">"{{ quote }}"</p></div>
        <div class="d-flex gap-3">
            <form action="/search" method="GET"><div class="search-box"><i class="bi bi-search"></i><input type="text" name="q" placeholder="Search tasks, notes..."></div></form>
            <button class="btn btn-primary rounded-circle shadow-lg d-flex align-items-center justify-content-center p-0" data-bs-toggle="modal" data-bs-target="#subjectModal" style="width: 52px; height: 52px;"><i class="bi bi-plus-lg fs-4"></i></button>
        </div>
    </div>

    {% if bottlenecks %}
        <div class="alert border-0 d-flex align-items-center gap-3 mb-4 shadow-sm" style="background: #fff7ed; color: #c2410c; border-left: 5px solid #f97316;">
            <i class="bi bi-fire fs-4"></i>
            <div><strong>High Pressure Alert:</strong> Multiple deadlines detected on {% for b in bottlenecks %}{{ b.date.strftime('%b %d') }} ({{ b.count }}){% if not loop.last %}, {% endif %}{% endfor %}</div>
        </div>
    {% endif %}

    {% if gaps %}
        <div class="gap-alert">
            <i class="bi bi-hourglass-split fs-4"></i>
            <div><strong>Gap Found:</strong> You have a free slot from <strong>{{ gaps[0].start }}:00</strong> to <strong>{{ gaps[0].end }}:00</strong> today!</div>
        </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <div class="dashboard-card d-flex align-items-center justify-content-between py-3">
                <div class="d-flex align-items-center gap-3">
                    <div class="widget-icon"><i class="bi bi-airplane-fill"></i></div>
                    <div><h6 class="fw-bold mb-0">Holiday Forecaster</h6><span class="text-muted small">Simulate attendance impact.</span></div>
                </div>
                <form action="/forecast" method="POST" class="d-flex gap-2">
                    <input type="date" name="start_date" class="form-control form-control-sm" required>
                    <input type="date" name="end_date" class="form-control form-control-sm" required>
                    <button type="submit" class="btn btn-sm btn-primary">Check</button>
                </form>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-lg-8">
            
            <div class="coach-card d-flex align-items-start gap-3">
                <div class="coach-icon"><i class="bi bi-lightbulb-fill"></i></div>
                <div>
                    <h5 class="fw-bold mb-1 text-dark">Smart Efficiency Insight</h5>
                    <p class="mb-0 text-muted small" style="line-height: 1.6;">
                        {% if gaps %}
                            üöÄ <strong>Gap Strategy:</strong> You have a {{ gaps[0].end - gaps[0].start }}h break at {{ gaps[0].start }}:00. Perfect time to finish short 'Delegate' tasks.
                        {% elif bottlenecks %}
                            üõ°Ô∏è <strong>Burnout Defense:</strong> Heavy workload on {{ bottlenecks[0].date.strftime('%a') }}. Use the <i>Pomodoro Technique</i> (25m work, 5m break) to stay focused.
                        {% else %}
                            üìÖ <strong>Plan Ahead:</strong> Your schedule is light today. Use this time to update your <b>Career Vault</b> or learn a new skill.
                        {% endif %}
                    </p>
                </div>
            </div>

            <div class="dashboard-card p-0 overflow-hidden">
                <div class="p-4 border-bottom d-flex justify-content-between align-items-center bg-light bg-opacity-50">
                    <h5 class="fw-bold mb-0">üìö My Courses</h5>
                    <button class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#subjectModal">Add Course</button>
                </div>
                <div class="table-responsive">
                    <table class="table mb-0">
                        <thead><tr><th class="ps-4 text-muted small fw-normal">COURSE</th><th class="text-muted small fw-normal">ATTENDANCE</th><th class="text-end pe-4 text-muted small fw-normal">ACTIONS</th></tr></thead>
                        <tbody>
                            {% for sub in subjects %}
                            <tr>
                                <td class="ps-4">
                                    <div class="fw-bold text-dark">{{ sub.code }}</div>
                                    <a href="/subject/{{ sub.id }}" class="small text-decoration-none fw-bold" style="color: var(--primary-color);">{{ sub.name }} <i class="bi bi-arrow-right-short"></i></a>
                                    <div class="mt-2" style="width: 140px;">
                                        <div class="d-flex justify-content-between" style="font-size: 0.65rem; color: var(--text-muted);"><span>Student</span><span>{{ sub.student_progress_percent }}%</span></div>
                                        <div class="syllabus-mini"><span class="syllabus-fill" style="width: {{ sub.student_progress_percent }}%; background: var(--primary-color);"></span></div>
                                        
                                        <div class="d-flex justify-content-between mt-1" style="font-size: 0.65rem; color: var(--text-muted);"><span>Teacher</span><span>{{ sub.teacher_progress_percent }}%</span></div>
                                        <div class="syllabus-mini"><span class="syllabus-fill" style="width: {{ sub.teacher_progress_percent }}%; background: #f59e0b;"></span></div>
                                    </div>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2 mb-1">
                                        <div class="fw-bold {% if sub.attendance_percentage < 75 %}text-danger{% else %}text-success{% endif %}">{{ sub.attendance_percentage }}%</div>
                                        <span class="badge bg-light text-dark border fw-normal" style="font-size: 0.7rem;">{{ sub.bunk_status }}</span>
                                    </div>
                                    <div class="progress progress-slim" style="width: 100px;"><div class="progress-bar {% if sub.attendance_percentage < 75 %}bg-danger{% else %}bg-success{% endif %}" style="width: {{ sub.attendance_percentage }}%"></div></div>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group">
                                        <a href="/update_attendance/{{ sub.id }}/present" class="btn btn-sm btn-outline-secondary"><i class="bi bi-check-lg text-success"></i></a>
                                        <a href="/update_attendance/{{ sub.id }}/absent" class="btn btn-sm btn-outline-secondary"><i class="bi bi-x-lg text-danger"></i></a>
                                        <a href="/undo_attendance/{{ sub.id }}" class="btn btn-sm btn-outline-secondary" title="Undo"><i class="bi bi-arrow-counterclockwise"></i></a>
                                        <a href="/history/{{ sub.id }}" class="btn btn-sm btn-outline-secondary"><i class="bi bi-clock-history"></i></a>
                                        <a href="/delete_subject/{{ sub.id }}" class="btn btn-sm btn-outline-secondary text-danger" title="Delete" onclick="return confirm('Are you sure?')"><i class="bi bi-trash"></i></a>
                                    </div>
                                </td>
                            </tr>
                            {% else %}<tr><td colspan="3" class="text-center py-5 text-muted">No courses added yet.</td></tr>{% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="dashboard-card mb-4">
                <div class="d-flex justify-content-between align-items-center mb-3"><h6 class="fw-bold mb-0">üìù Notes</h6></div>
                <form action="/add_note" method="POST" class="mb-3">
                    <div class="input-group"><input type="text" name="content" class="form-control form-control-sm" placeholder="Quick note..." required><button class="btn btn-sm btn-primary"><i class="bi bi-plus-lg"></i></button></div>
                </form>
                <div style="max-height: 200px; overflow-y: auto;">
                    {% for note in notes %}
                    <div class="p-2 mb-2 rounded bg-light border position-relative" style="font-size: 0.85rem;">
                        {{ note.content }}<a href="/delete_note/{{ note.id }}" class="position-absolute top-0 end-0 p-1 text-danger"><i class="bi bi-x"></i></a>
                    </div>
                    {% else %}<div class="text-center text-muted small">Empty.</div>{% endfor %}
                </div>
            </div>

            <div class="dashboard-card p-0">
                <div class="p-3 border-bottom d-flex justify-content-between align-items-center bg-light bg-opacity-50">
                    <h6 class="fw-bold mb-0">‚úÖ Tasks</h6>
                    <button class="btn btn-sm btn-primary rounded-pill px-3 py-1" data-bs-toggle="modal" data-bs-target="#taskModal">+ New</button>
                </div>
                <div class="list-group list-group-flush">
                    {% if assignments %}
                        {% for task in assignments %}
                        <div class="list-group-item bg-transparent border-bottom d-flex align-items-center justify-content-between py-3 px-3 position-relative" style="overflow: hidden;">
                            <div class="task-strip border-{{ task.color_tag or 'emerald' }}"></div>
                            <div class="d-flex align-items-center gap-3 ps-2">
                                <a href="/mark_done/{{ task.id }}" class="btn btn-sm btn-outline-secondary rounded-circle p-0 d-flex align-items-center justify-content-center" style="width: 24px; height: 24px;"><i class="bi bi-check"></i></a>
                                <div>
                                    <div class="fw-bold small">{{ task.title }}</div>
                                    <div class="text-muted" style="font-size: 0.75rem;">
                                        {{ task.subject.code }} ‚Ä¢ {{ task.due_date.strftime('%b %d') }}
                                        {% if task.estimated_hours and task.estimated_hours > 0 %}
                                            <span class="badge bg-light text-secondary border ms-1 fw-normal">{{ task.estimated_hours }}h</span>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                            {% if task.is_exam %}<span class="badge bg-danger rounded-pill fw-normal">EXAM</span>{% endif %}
                        </div>
                        {% endfor %}
                    {% else %}<div class="p-4 text-center text-muted small">No pending tasks.</div>{% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="profileModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Settings</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/update_profile" method="POST"><label class="small text-muted fw-bold mb-1">NAME</label><input type="text" name="student_name" class="form-control mb-3" value="{{ settings.student_name }}"><label class="small text-muted fw-bold mb-1">UNIVERSITY</label><input type="text" name="university" class="form-control mb-4" value="{{ settings.university }}"><button type="submit" class="btn btn-primary w-100">Save</button></form></div></div></div></div>

<div class="modal fade" id="subjectModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered" style="max-width: 600px;"><div class="modal-content p-2"><div class="modal-header border-0 pb-0"><h5 class="modal-title fw-bold">Add Course</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><form action="/add_subject" method="POST"><input type="text" name="name" class="form-control mb-3" placeholder="Name" required><div class="row g-2 mb-3"><div class="col-6"><input type="text" name="code" class="form-control" placeholder="Code" required></div><div class="col-6"><input type="text" name="prof" class="form-control" placeholder="Prof"></div></div><label class="small text-muted fw-bold mb-2">SCHEDULE</label><div id="schedule-container"><div class="row g-2 mb-2 schedule-row"><div class="col-3"><select name="days" class="form-select bg-light border-0"><option value="MON">Mon</option><option value="TUE">Tue</option><option value="WED">Wed</option><option value="THU">Thu</option><option value="FRI">Fri</option></select></div><div class="col-3"><select name="start_times" class="form-select bg-light border-0"><option value="8">8AM</option><option value="9">9AM</option><option value="10">10AM</option><option value="11">11AM</option><option value="14">2PM</option><option value="15">3PM</option><option value="16">4PM</option><option value="17">5PM</option><option value="18">6PM</option><option value="19">7PM</option></select></div><div class="col-3"><select name="end_times" class="form-select bg-light border-0"><option value="9">9AM</option><option value="10">10AM</option><option value="11">11AM</option><option value="12">12PM</option><option value="13">1PM</option><option value="15">3PM</option><option value="16">4PM</option><option value="17">5PM</option><option value="18">6PM</option><option value="19">7PM</option><option value="20">8PM</option></select></div><div class="col-2"><select name="types" class="form-select bg-light border-0" style="font-size: 0.8rem;"><option value="T">Theory</option><option value="L">Lab</option></select></div><div class="col-1"><button type="button" class="btn btn-outline-secondary w-100 border-0 px-0" onclick="removeRow(this)">√ó</button></div></div></div><div class="text-end mb-4"><button type="button" class="btn btn-sm btn-outline-secondary" onclick="addScheduleRow()">+ Add Slot</button></div><button type="submit" class="btn btn-primary w-100 py-2">Save Course</button></form></div></div></div></div>

<div class="modal fade" id="taskModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content p-2"><div class="modal-body p-4"><h5 class="fw-bold mb-4">Create New Task</h5>{% if not subjects %}<div class="alert alert-warning small">Please add a course first!</div>{% else %}<form action="/add_assignment" method="POST"><select name="subject_id" class="form-select mb-3" required>{% for sub in subjects %}<option value="{{ sub.id }}">{{ sub.code }}</option>{% endfor %}</select><input type="text" name="title" class="form-control mb-3" placeholder="Task Title" required><div class="row g-2 mb-3"><div class="col-6"><input type="date" name="due_date" class="form-control" required></div><div class="col-6"><input type="number" step="0.5" name="hours" class="form-control" placeholder="Est. Hours"></div></div><label class="small text-muted fw-bold mb-2 d-block">COLOR TAG</label><div class="d-flex mb-4 gap-2 justify-content-start"><input type="radio" name="color_tag" value="emerald" id="c1" class="d-none" checked><label for="c1" class="color-option bg-emerald"></label><input type="radio" name="color_tag" value="blue" id="c2" class="d-none"><label for="c2" class="color-option bg-blue"></label><input type="radio" name="color_tag" value="purple" id="c3" class="d-none"><label for="c3" class="color-option bg-purple"></label><input type="radio" name="color_tag" value="amber" id="c4" class="d-none"><label for="c4" class="color-option bg-amber"></label><input type="radio" name="color_tag" value="rose" id="c5" class="d-none"><label for="c5" class="color-option bg-rose"></label><input type="radio" name="color_tag" value="slate" id="c6" class="d-none"><label for="c6" class="color-option bg-slate"></label></div><div class="form-check form-switch mb-4"><input class="form-check-input" type="checkbox" name="is_exam" id="isExam"><label class="form-check-label" for="isExam">This is an Exam</label></div><button type="submit" class="btn btn-primary w-100">Save</button></form>{% endif %}</div></div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('/static/sw.js'); }); }
    document.querySelectorAll('.color-option').forEach(el => { el.addEventListener('click', function() { document.querySelectorAll('.color-option').forEach(opt => opt.style.transform = 'scale(1)'); this.style.transform = 'scale(1.2)'; }); });

    // DYNAMIC SCHEDULE ROWS
    function addScheduleRow() {
        const container = document.getElementById('schedule-container');
        const newRow = container.firstElementChild.cloneNode(true);
        // Reset values in the new row
        newRow.querySelectorAll('select').forEach(sel => sel.selectedIndex = 0);
        container.appendChild(newRow);
    }
    function removeRow(btn) {
        const container = document.getElementById('schedule-container');
        if (container.children.length > 1) {
            btn.closest('.schedule-row').remove();
        }
    }
</script>
</body>
</html>